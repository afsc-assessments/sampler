---
title: "Sampler Documentation"
author: "Jim Ianelli"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
execute:
  echo: false
  warning: false
  message: false
---

# Overview

This repository contains two operational paths for generating sampler outputs:

1. ADMB executable workflow (legacy and still supported).
2. R refactor workflow (`R/sampler_refactor.R`) that preserves the same input file formats and writes tidy Parquet outputs.

Both paths use the same core input files:

- `sam*.dat` control files
- `age*.dat` age sample files
- `len*.dat` length sample files
- `bs_setup.dat` bootstrap settings

# Repository Map

- `src/`: ADMB template (`sam.tpl`) and Makefile for compiling `sam`.
- `admb/`: alternate ADMB build area.
- `R/`: R scripts, including the refactor entry point.
- `example/`: small synthetic inputs for smoke testing.
- `cases/`: historical species/assessment-specific data and scripts.
- `index.qmd`: this documentation source.

# Input File Formats

## Control File (`sam*.dat`)

Token order expected by both ADMB (`src/sam.tpl`) and R (`R/sampler_refactor.R`):

| Position | Name | Description |
|---|---|---|
| 1 | `year` | Model year label |
| 2 | `agefile` | Path to age file |
| 3 | `lenfile` | Path to length file |
| 4 | `na_rcrds` | Number of age records |
| 5 | `nl_rcrds` | Number of length records |
| 6 | `a1` | Min age |
| 7 | `a2` | Max age |
| 8 | `l1` | Min length bin |
| 9 | `l2` | Max length bin |
| 10 | `nstrata` | Number of strata |
| 11..(10+`nstrata`) | `strata_catch` | Catch by stratum |
| last | `outfile` | Main output file label |

Example (`example/sam2020.dat`):

```text
2020 age2020.dat len2020.dat 6 6 2 5 30 38 1 100 results/Est_2020.dat
```

## Age File (`age*.dat`)

Six columns:

```text
strata haul sex age wt len
```

## Length File (`len*.dat`)

Five columns:

```text
strata haul sex len freq
```

## Bootstrap Setup (`bs_setup.dat`)

Expected numeric values, one per line:

1. `nbs` (number of bootstrap iterations; `0`/`1` means no bootstrap expansion in many use cases)
2. `sam_level_age_tows`
3. `sam_level_ages`
4. `sam_level_lf_tows`
5. `sam_level_lfreqs`

Example (`example/bs_setup.dat`):

```text
5
2
2
2
2
```

# ADMB Workflow

## Build

From repository root:

```bash
cd src
make clean
make
```

This compiles `sam` from `sam.tpl`.

## Run

Run from a directory containing `sam*.dat`, `age*.dat`, `len*.dat`, and `bs_setup.dat` (for example `example/`):

```bash
cd example
../src/sam -ind sam2020.dat
```

## ADMB Runtime Options

Options parsed in `sam.tpl`:

- `-io`: enable additional diagnostic printing.
- `-sim`: simulation mode flag.

Example:

```bash
../src/sam -nox -io -ind sam2020.dat
```

## ADMB Outputs

ADMB writes multiple `.rep` files under `results/` (relative to the run directory), including:

- `sex_catage<year>.rep`
- `catage<year>.rep`
- `str_catage<year>.rep`
- `sex_wtage<year>.rep`
- `wtage<year>.rep`
- `str_wtage<year>.rep`
- `LF_<year>.rep`
- `alk_<year>.rep`
- `wl_<year>.rep`

# R Refactor Workflow

Refactor entry point: `run_sampler_refactor()` in `R/sampler_refactor.R`.

## Prerequisites

R packages:

- `data.table`
- `arrow`

## Recommended Run Commands

From repository root:

```bash
make example
```

Equivalent direct call:

```bash
cd example
R -q -e "source('../R/sampler_refactor.R'); run_sampler_refactor('sam2020.dat','bs_setup.dat','../results')"
```

## Function Arguments

| Argument | Default | Description |
|---|---|---|
| `control_file` | required | Path to `sam*.dat` |
| `bs_file` | `"bs_setup.dat"` | Path to bootstrap file |
| `out_dir` | `"results"` | Output directory |
| `out_prefix` | `"sampler"` | Output file prefix |

## R Outputs

- `results/<prefix>_tidy.parquet`
- `results/<prefix>_bootstrap_<year>.parquet` (if `nbs >= 1`)
- `results/<prefix>_refactor.log`

## Notes on Paths

`sam*.dat` usually stores `agefile` and `lenfile` as relative names (for example `age2020.dat`).
Use the same working directory as those files (for example `example/`) when running.

# Query-Based Data Preparation (Legacy)

Legacy query scripts live in `R/`:

- `R/CallQueriesForSamplerData.R`
- `R/QueryAgesForSampler.R`
- `R/QueryLengthsForSampler.R`
- `R/QueryCatchByStrata.R`

These use AFSC/AKFIN ODBC connections and keyring credentials to generate `age*.dat`, `len*.dat`, and `sam*.dat` files.

# Render This Documentation

From repository root:

```bash
quarto render index.qmd
```

This produces `index.html` in the repository root.

# Push to GitHub

Typical update sequence:

```bash
git add index.qmd index.html
git commit -m "Update sampler documentation"
git push origin <branch>
```

If your repository uses GitHub Pages from root or `gh-pages`, commit `index.html` accordingly.

# Troubleshooting

- `Package 'arrow' is required for Parquet output.`
  - Install `arrow` in your R library before running the refactor.
- `quarto: command not found`
  - Install Quarto and ensure it is on your PATH.
- ADMB binary not found
  - Ensure `admb` and/or compiled `sam` exists and is executable.
