---
title: "Sampler Documentation"
author: "Jim Ianelli"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
execute:
  echo: false
  warning: false
  message: false
---

# Overview

This repository contains two operational paths for generating sampler outputs:

1. ADMB executable workflow (legacy and still supported).
2. R refactor workflow (`R/sampler_refactor.R`) that preserves the same input file formats and writes tidy Parquet outputs.

Both paths use the same core input files:

- `sam*.dat` control files
- `age*.dat` age sample files
- `len*.dat` length sample files
- `bs_setup.dat` bootstrap settings

# Repository Map

- `src/`: ADMB template (`sam.tpl`) and Makefile for compiling `sam`.
- `admb/`: alternate ADMB build area.
- `R/`: R scripts, including the refactor entry point.
- `example/`: small synthetic inputs for smoke testing.
- `cases/`: historical species/assessment-specific data and scripts.
- `index.qmd`: this documentation source.

# Input File Formats

## Control File (`sam*.dat`)

Token order expected by both ADMB (`src/sam.tpl`) and R (`R/sampler_refactor.R`):

| Position | Name | Description |
|---|---|---|
| 1 | `year` | Model year label |
| 2 | `agefile` | Path to age file |
| 3 | `lenfile` | Path to length file |
| 4 | `na_rcrds` | Number of age records |
| 5 | `nl_rcrds` | Number of length records |
| 6 | `a1` | Min age |
| 7 | `a2` | Max age |
| 8 | `l1` | Min length bin |
| 9 | `l2` | Max length bin |
| 10 | `nstrata` | Number of strata |
| 11..(10+`nstrata`) | `strata_catch` | Catch by stratum |
| last | `outfile` | Main output file label |

Example (`example/sam2020.dat`):

```text
2020 age2020.dat len2020.dat 6 6 2 5 30 38 1 100 results/Est_2020.dat
```

## Age File (`age*.dat`)

Six columns:

```text
strata haul sex age wt len
```

## Length File (`len*.dat`)

Five columns:

```text
strata haul sex len freq
```

## Bootstrap Setup (`bs_setup.dat`)

Expected numeric values, one per line:

1. `nbs` (number of bootstrap iterations; `0`/`1` means no bootstrap expansion in many use cases)
2. `sam_level_age_tows`
3. `sam_level_ages`
4. `sam_level_lf_tows`
5. `sam_level_lfreqs`

Example (`example/bs_setup.dat`):

```text
5
2
2
2
2
```

# ADMB Workflow

## Build

From repository root:

```bash
cd src
make clean
make
```

This compiles `sam` from `sam.tpl`.

## Run

Run from a directory containing `sam*.dat`, `age*.dat`, `len*.dat`, and `bs_setup.dat` (for example `example/`):

```bash
cd example
../src/sam -ind sam2020.dat
```

## ADMB Runtime Options

Options parsed in `sam.tpl`:

- `-io`: enable additional diagnostic printing.
- `-sim`: simulation mode flag.

Example:

```bash
../src/sam -nox -io -ind sam2020.dat
```

## ADMB Outputs

ADMB writes multiple `.rep` files under `results/` (relative to the run directory), including:

- `sex_catage<year>.rep`
- `catage<year>.rep`
- `str_catage<year>.rep`
- `sex_wtage<year>.rep`
- `wtage<year>.rep`
- `str_wtage<year>.rep`
- `LF_<year>.rep`
- `alk_<year>.rep`
- `wl_<year>.rep`

# R Refactor Workflow

Refactor entry point: `run_sampler_refactor()` in `R/sampler_refactor.R`.

## Prerequisites

R packages:

- `data.table`
- `arrow`

## Recommended Run Commands

From repository root:

```bash
make example
```

Equivalent direct call:

```bash
cd example
R -q -e "source('../R/sampler_refactor.R'); run_sampler_refactor('sam2020.dat','bs_setup.dat','../results')"
```

## Function Arguments

| Argument | Default | Description |
|---|---|---|
| `control_file` | required | Path to `sam*.dat` |
| `bs_file` | `"bs_setup.dat"` | Path to bootstrap file |
| `out_dir` | `"results"` | Output directory |
| `out_prefix` | `"sampler"` | Output file prefix |

## R Outputs

- `results/<prefix>_tidy.parquet`
- `results/<prefix>_bootstrap_<year>.parquet` (if `nbs >= 1`)
- `results/<prefix>_refactor.log`

## Notes on Paths

`sam*.dat` usually stores `agefile` and `lenfile` as relative names (for example `age2020.dat`).
Use the same working directory as those files (for example `example/`) when running.

# Core Equations

The model composes age and length information from fishery and survey samples with standard multinomial-style proportions and bootstrap summaries.

## Length-frequency proportions

For year $y$, sex $s$, and length bin $l$:

$$
p_{y,s,l} = \frac{n_{y,s,l}}{\sum_{l'} n_{y,s,l'}}
$$

where $n_{y,s,l}$ is the sampled count at length.

## Age-length key (ALK)

For age $a$ and length bin $l$:

$$
P(a \mid l, y, s) = \frac{n_{y,s,a,l}}{\sum_{a'} n_{y,s,a',l}}
$$

This maps observed length composition to age composition.

## Catch-at-length and catch-at-age

Given total catch in numbers $C_{y,s}$:

$$
C_{y,s,l} = C_{y,s} \cdot p_{y,s,l}
$$

and catch-at-age is obtained by marginalizing over length:

$$
C_{y,s,a} = \sum_l C_{y,s,l} \cdot P(a \mid l, y, s)
$$

## Mean weight-at-age and mean weight-at-length

For sampled weights $w_i$:

$$
\bar{w}_{y,s,a} = \frac{1}{N_{y,s,a}} \sum_{i=1}^{N_{y,s,a}} w_i
$$

$$
\bar{w}_{y,s,l} = \frac{1}{N_{y,s,l}} \sum_{i=1}^{N_{y,s,l}} w_i
$$

## Strata roll-up in output files

In `results/Est_<year>.dat`, rows are stored as `year type stratum sex age value` with:

- `stratum = 1..H` for explicit strata,
- `stratum = 99` for all-strata aggregate,
- `sex = 99` for both-sex aggregate.

For stratum $k$, sex $s$, and age $a$, numbers-at-age are:

$$
N_{y,k,s,a} = \sum_l \mathrm{LF}_{y,k,s,l}\, \mathrm{ALK}_{y,k,s,l,a}
$$

where $\mathrm{LF}$ is the stratum-specific length frequency and $\mathrm{ALK}$ is the stratum-specific age-length key.

Define stratum-sex-age biomass-at-age as:

$$
B_{y,k,s,a} = \sum_l \left(\mathrm{LF}_{y,k,s,l}\,\bar{w}_{y,k,s,l}\right)\, \mathrm{ALK}_{y,k,s,l,a}
$$

and mean weight-at-age as:

$$
\bar{w}_{y,k,s,a} = \frac{B_{y,k,s,a}}{N_{y,k,s,a}}
$$

Roll-up equations used for `stratum=99` and/or `sex=99` are:

$$
N_{y,k,99,a} = \sum_s N_{y,k,s,a}, \qquad
N_{y,99,s,a} = \sum_k N_{y,k,s,a}, \qquad
N_{y,99,99,a} = \sum_k \sum_s N_{y,k,s,a}
$$

$$
\bar{w}_{y,99,99,a} =
\frac{\sum_k \sum_s N_{y,k,s,a}\,\bar{w}_{y,k,s,a}}
{\sum_k \sum_s N_{y,k,s,a}}
$$

So the annual/combined output is a stratum-weighted aggregation, not an unweighted average across strata.

## Bootstrap summary statistics

From bootstrap replicates $\theta^{(b)}$, $b = 1,\dots,B$:

$$
\hat{\mu}_\theta = \frac{1}{B} \sum_{b=1}^{B} \theta^{(b)}
$$

$$
\widehat{\mathrm{sd}}(\theta) = \sqrt{\frac{1}{B-1} \sum_{b=1}^{B} \left(\theta^{(b)} - \hat{\mu}_\theta\right)^2}
$$

$$
\mathrm{CV}(\theta) = \frac{\widehat{\mathrm{sd}}(\theta)}{\hat{\mu}_\theta}
$$

# `cases/ebswpSAM` Focus

This directory contains the Eastern Bering Sea walleye pollock workflow, with two practical data layouts:

1. Archived fishery inputs in `cases/ebswpSAM/data/fishery/` using `samYYYY.dat`, `ageYYYY.dat`, `lenYYYY.dat`.
2. Generated working inputs expected by some scripts/Makefile in `cases/ebswpSAM/data/` using `sam_YYYY.dat`, `ageYYYY.dat`, `lenYYYY.dat`.

## Recommended: archived fishery run (`data/fishery`)

Run from the directory that contains the `samYYYY.dat` control files so relative `age/len` filenames resolve correctly.

### ADMB run for one year

```bash
cd cases/ebswpSAM/data/fishery
cat > bs_setup.dat <<'TXT'
1
1
1
1
1
TXT
../../../src/sam -ind sam2024.dat
```

### R refactor run for one year

```bash
cd cases/ebswpSAM/data/fishery
cat > bs_setup.dat <<'TXT'
1000
2
2
2
2
TXT
R -q -e "source('../../../R/sampler_refactor.R'); run_sampler_refactor('sam2024.dat','bs_setup.dat','results','ebswp')"
```

## Alternate: generated-data run (`cases/ebswpSAM/Makefile`)

`cases/ebswpSAM/Makefile` runs:

```bash
./sam -ind data/sam_<year>.dat
```

Example:

```bash
cd cases/ebswpSAM
make yr=2024
```

Use this only when `data/sam_<year>.dat` exists (underscore form). Archived fishery controls are named `sam<year>.dat` (no underscore).

## Quick commands (year ranges)

Run a range of archived `data/fishery/samYYYY.dat` control files with ADMB:

```bash
cd cases/ebswpSAM/data/fishery
cat > bs_setup.dat <<'TXT'
1
1
1
1
1
TXT
for y in $(seq 1991 2024); do
  ../../../src/sam -ind "sam${y}.dat"
done
```

Run a range with the R refactor (writes one Parquet pair per year prefix):

```bash
cd cases/ebswpSAM/data/fishery
cat > bs_setup.dat <<'TXT'
1000
2
2
2
2
TXT
for y in $(seq 2020 2024); do
  R -q -e "source('../../../R/sampler_refactor.R'); run_sampler_refactor('sam${y}.dat','bs_setup.dat','results','ebswp_${y}')"
done
```

## Key ebswpSAM scripts

- `cases/ebswpSAM/EBS_sampler2023.R`: end-to-end prep + diagnostics for recent years.
- `cases/ebswpSAM/sampler.R`: defines `Sampler()` and `SetBS()` utilities used in case workflows.
- `cases/ebswpSAM/ebs_survey.R`: survey-oriented conversion and sampler runs.
- `cases/ebswpSAM/imported/poll_age.sql` and `cases/ebswpSAM/imported/poll_len.sql`: source SQL templates.

## Known path caveats

- Several legacy scripts in this case directory contain machine-specific `setwd()`/`source()` paths and may need local edits before execution.
- Some scripts reference `sampleR/R/sampler_EBSwp.R`; verify that file exists in your local clone or update the `source()` target to the intended sampler helper.

# Query-Based Data Preparation (Legacy)

Legacy query scripts live in `R/`:

- `R/CallQueriesForSamplerData.R`
- `R/QueryAgesForSampler.R`
- `R/QueryLengthsForSampler.R`
- `R/QueryCatchByStrata.R`

These use AFSC/AKFIN ODBC connections and keyring credentials to generate `age*.dat`, `len*.dat`, and `sam*.dat` files.

# Render This Documentation

From repository root:

```bash
quarto render index.qmd
```

This produces `index.html` in the repository root.

# Push to GitHub

Typical update sequence:

```bash
git add index.qmd index.html
git commit -m "Update sampler documentation"
git push origin <branch>
```

If your repository uses GitHub Pages from root or `gh-pages`, commit `index.html` accordingly.

# Troubleshooting

- `Package 'arrow' is required for Parquet output.`
  - Install `arrow` in your R library before running the refactor.
- `quarto: command not found`
  - Install Quarto and ensure it is on your PATH.
- ADMB binary not found
  - Ensure `admb` and/or compiled `sam` exists and is executable.
